\-- Micasa MVP Database Schema  
\-- Based on SOW v8.0 and Screen Lists SL7 v4.0, Web v2.4

\-- \=============================================  
\-- 1\. Core User Management  
\-- \=============================================

CREATE TABLE Users (  
    user\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    email VARCHAR(255) UNIQUE,  
    username VARCHAR(50) UNIQUE NOT NULL,  
    phone\_number VARCHAR(20) UNIQUE, \-- Mandatory for creators (Screen 25), optional for guests  
    is\_phone\_verified BOOLEAN DEFAULT FALSE,  
    hashed\_password VARCHAR(255), \-- Nullable for OAuth users  
      
    \-- Profile Fields  
    profile\_picture\_url TEXT,  
    bio TEXT,  
    instagram\_handle VARCHAR(100),  
    personal\_website\_url TEXT,  
      
    \-- Platform Flags & Tokens (JIT Friction)  
    hyperwallet\_user\_token VARCHAR(255), \-- Required for payouts (Screen 20\)  
    stripe\_customer\_id VARCHAR(255),  
    is\_username\_autogenerated BOOLEAN DEFAULT TRUE, \-- Used for Mandatory Profile Initialization Gate (Screen 25\)  
      
    \-- Privacy Settings (Screen 16\)  
    privacy\_show\_upcoming\_events BOOLEAN DEFAULT TRUE,  
    privacy\_show\_past\_events BOOLEAN DEFAULT TRUE,  
    privacy\_past\_events\_include\_hosted BOOLEAN DEFAULT TRUE,  
    privacy\_past\_events\_include\_collaborated BOOLEAN DEFAULT TRUE,  
    privacy\_past\_events\_include\_attended BOOLEAN DEFAULT TRUE,

    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    updated\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- \=============================================  
\-- 2\. Event Core  
\-- \=============================================

CREATE TABLE Events (  
    event\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    host\_user\_id UUID NOT NULL REFERENCES Users(user\_id), \-- The primary host  
    title VARCHAR(255) NOT NULL,  
    description TEXT,  
    cover\_image\_url TEXT,  
    start\_time TIMESTAMP WITH TIME ZONE NOT NULL,  
    end\_time TIMESTAMP WITH TIME ZONE NOT NULL,  
    location\_address TEXT NOT NULL,  
    status VARCHAR(50) NOT NULL CHECK (status IN ('draft', 'published', 'live', 'completed', 'cancelled')),

    \-- Configuration & Rules (Screen 6\)  
    location\_visibility VARCHAR(50) NOT NULL CHECK (location\_visibility IN ('immediate', 'confirmed\_guests', '24\_hours\_before')),  
    \-- Three-tier guest list visibility  
    guest\_list\_visibility VARCHAR(50) NOT NULL CHECK (guest\_list\_visibility IN ('public', 'attendees\_live', 'private')),  
    is\_invite\_only BOOLEAN DEFAULT FALSE,  
    max\_capacity INTEGER,

    \-- Pricing (Screen 6\)  
    pricing\_model VARCHAR(50) NOT NULL CHECK (pricing\_model IN ('fixed\_price', 'choose\_your\_price', 'donation\_based', 'free\_rsvp')),  
    currency VARCHAR(3) DEFAULT 'USD',  
    price\_fixed NUMERIC(10, 2),  
    price\_min NUMERIC(10, 2),  
    price\_suggested NUMERIC(10, 2),

    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    updated\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- \=============================================  
\-- 3\. Collaboration System  
\-- \=============================================

\-- Collaborations Table: Manages the team, proposals, and roles.  
CREATE TABLE Collaborations (  
    collaboration\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID NOT NULL REFERENCES Events(event\_id) ON DELETE CASCADE,  
      
    \-- Invitee Identification (Supports inviting users not yet registered via SMS)  
    user\_id UUID REFERENCES Users(user\_id),   
    invited\_phone\_number VARCHAR(20), \-- Used if user\_id is null initially; user\_id is backfilled on signup.  
      
    invited\_by\_user\_id UUID REFERENCES Users(user\_id),  
      
    \-- Role and Terms  
    role\_title VARCHAR(30) NOT NULL, \-- Custom role title (Max 30 chars enforced by spec)  
    profit\_share\_percentage NUMERIC(5, 2\) NOT NULL DEFAULT 0.00,  
    is\_cohost BOOLEAN DEFAULT FALSE, \-- Elevated privileges (Screen 9\)  
      
    \-- Status tracking proposals, removals, and disputes (Screens 12, 21\)  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'accepted', 'declined', 'pending\_removal', 'removed', 'disputed')),  
    invitation\_message TEXT, \-- Personal message from host (Screen 9\)  
      
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    responded\_at TIMESTAMP WITH TIME ZONE  
);

\-- OpenPositions Table (Screen 11\)  
CREATE TABLE OpenPositions (  
    position\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID NOT NULL REFERENCES Events(event\_id) ON DELETE CASCADE,  
    role\_title VARCHAR(30) NOT NULL,  
    description TEXT,  
    profit\_share\_percentage NUMERIC(5, 2),  
    status VARCHAR(50) NOT NULL CHECK (status IN ('open', 'filled', 'closed')),  
    filled\_by\_user\_id UUID REFERENCES Users(user\_id),  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- Applications Table (Screen 10, W-4)  
CREATE TABLE Applications (  
    application\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    position\_id UUID NOT NULL REFERENCES OpenPositions(position\_id) ON DELETE CASCADE,  
    user\_id UUID NOT NULL REFERENCES Users(user\_id),  
    message TEXT,  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'accepted', 'declined', 'withdrawn')),  
    applied\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    \-- Enforces SOW requirement: one application per user per position  
    UNIQUE(position\_id, user\_id),
    accepted_collaboration_id UUID REFERENCES Collaborations(collaboration_id);  
);

\-- \=============================================  
\-- 4\. Financial System  
\-- \=============================================

\-- Transactions Table: Records all incoming payments (Stripe).  
CREATE TABLE Transactions (  
    transaction\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID NOT NULL REFERENCES Events(event\_id),  
    user\_id UUID NOT NULL REFERENCES Users(user\_id), \-- The purchaser  
    amount\_gross NUMERIC(10, 2\) NOT NULL,  
    platform\_fee NUMERIC(10, 2\) NOT NULL,  
    stripe\_fee NUMERIC(10, 2\) NOT NULL,  
    amount\_net NUMERIC(10, 2\) NOT NULL,  
    currency VARCHAR(3) NOT NULL,  
    stripe\_charge\_id VARCHAR(255),  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'succeeded', 'failed', 'refunded')),  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- EventSettlements Table: Summary and status of financials for an event (Screen 7.1, 27).  
CREATE TABLE EventSettlements (  
    settlement\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID UNIQUE NOT NULL REFERENCES Events(event\_id) ON DELETE CASCADE,  
    gross\_revenue NUMERIC(12, 2\) NOT NULL,  
    total\_fees NUMERIC(12, 2\) NOT NULL,  
    net\_revenue NUMERIC(12, 2\) NOT NULL, \-- Amount to be distributed  
    \-- Status management (Screen 7.1); frozen during disputes (Screen 21\)  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending\_review', 'host\_confirmed', 'processing', 'completed', 'frozen\_dispute')),  
    confirmed\_at TIMESTAMP WITH TIME ZONE  
);

\-- Payouts Table: Individual line-item payouts to collaborators (Hyperwallet) (Screen 15.2).  
CREATE TABLE Payouts (  
    payout\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    settlement\_id UUID NOT NULL REFERENCES EventSettlements(settlement\_id),  
    collaboration\_id UUID NOT NULL REFERENCES Collaborations(collaboration\_id),  
    user\_id UUID NOT NULL REFERENCES Users(user\_id),  
    amount NUMERIC(12, 2\) NOT NULL,  
    hyperwallet\_payment\_id VARCHAR(255),  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'processing', 'paid', 'failed')),  
    paid\_at TIMESTAMP WITH TIME ZONE  
);

\-- \=============================================  
\-- 5\. Guest Management, Ticketing & Invitations  
\-- \=============================================

\-- PrivateEventInvitations Table (Screen 17, 7.2)  
CREATE TABLE PrivateEventInvitations (  
    invitation\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID NOT NULL REFERENCES Events(event\_id),  
    inviter\_user\_id UUID NOT NULL REFERENCES Users(user\_id),  
    invitee\_user\_id UUID REFERENCES Users(user\_id),  
    invitee\_phone\_number VARCHAR(20),  
    status VARCHAR(50) NOT NULL CHECK (status IN ('pending', 'accepted', 'declined')),  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,
    is_sharable BOOLEAN DEFAULT TRUE  
);

\-- Tickets (RSVPs) Table: Represents a guest's attendance and tracks attribution.  
CREATE TABLE Tickets (  
    ticket\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    event\_id UUID NOT NULL REFERENCES Events(event\_id) ON DELETE CASCADE,  
    user\_id UUID NOT NULL REFERENCES Users(user\_id),  
      
    \-- Financial Link  
    transaction\_id UUID REFERENCES Transactions(transaction\_id), \-- Nullable for Free RSVP

    \-- Attribution (SOW requirement)  
    referrer\_user\_id UUID REFERENCES Users(user\_id),   
    invitation\_id UUID REFERENCES PrivateEventInvitations(invitation\_id),

    \-- Status (Screen 18, 19\)  
    rsvp\_status VARCHAR(50) CHECK (rsvp\_status IN ('going', 'maybe', 'not\_going')), \-- For Free/Donation events  
    checked\_in BOOLEAN DEFAULT FALSE,  
    checked\_in\_at TIMESTAMP WITH TIME ZONE,  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- \=============================================  
\-- 6\. Community & Social Graph  
\-- \=============================================

\-- Contacts Table: User's personal community list (Screen 14).  
CREATE TABLE Contacts (  
    contact\_entry\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    owner\_user\_id UUID NOT NULL REFERENCES Users(user\_id),  
    linked\_user\_id UUID REFERENCES Users(user\_id), \-- Link to Micasa user if they exist  
    display\_name VARCHAR(255),  
    phone\_number VARCHAR(20),  
    source VARCHAR(50) CHECK (source IN ('manual', 'phone\_import', 'guest\_list\_import', 'profile\_add')),  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    \-- Prevents duplicate entries for the same owner linking the same user  
    UNIQUE(owner\_user\_id, linked\_user\_id)  
);

\-- EventAssociations Table: The Dynamic Social Graph (SOW Principle).  
\-- Tracks who participated in which event (in any role) to enable "Group by Event" views (Screen 14).  
CREATE TABLE EventAssociations (  
    event\_id UUID NOT NULL REFERENCES Events(event\_id),  
    user\_id UUID NOT NULL REFERENCES Users(user\_id),  
    role VARCHAR(50) NOT NULL CHECK (role IN ('host', 'cohost', 'collaborator', 'attendee')),  
    PRIMARY KEY(event\_id, user\_id) \-- Composite Primary Key for efficient join table  
);

\-- \=============================================  
\-- 7\. Supporting Systems  
\-- \=============================================

\-- Stores push notification device tokens for users  
CREATE TABLE DeviceTokens (  
    token\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    user\_id UUID NOT NULL REFERENCES Users(user\_id) ON DELETE CASCADE,  
    device\_token TEXT NOT NULL,  
    device\_os VARCHAR(50) NOT NULL CHECK (device\_os IN ('ios', 'android')),  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP,  
    UNIQUE(user\_id, device\_token)  
);

\-- Stores in-app notifications for users (for an inbox/feed)  
CREATE TABLE Notifications (  
    notification\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    user\_id UUID NOT NULL REFERENCES Users(user\_id) ON DELETE CASCADE, \-- The recipient  
    title VARCHAR(255) NOT NULL,  
    body TEXT,  
    notification\_type VARCHAR(50) NOT NULL, \-- e.g., 'new\_proposal', 'application\_accepted'  
    link\_url TEXT, \-- Deep link for in-app navigation  
    is\_read BOOLEAN DEFAULT FALSE,  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);

\-- Stores all incoming webhook events from third-party services  
CREATE TABLE WebhookEvents (  
    event\_id UUID PRIMARY KEY DEFAULT gen\_random\_uuid(),  
    source VARCHAR(50) NOT NULL, \-- 'stripe', 'hyperwallet'  
    payload JSONB NOT NULL,  
    status VARCHAR(50) NOT NULL CHECK (status IN ('received', 'processed', 'failed')),  
    processed\_at TIMESTAMP WITH TIME ZONE,  
    error\_message TEXT,  
    created\_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT\_TIMESTAMP  
);  
